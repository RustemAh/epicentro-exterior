<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Presidencial 2025 ‚Äî Voto en el Extranjero</title>
<style>
:root {
  color-scheme: light;
  --bg: #f8fafc;
  --card-bg: #ffffff;
  --border: #d1d5db;
  --text-main: #111827;
  --text-muted: #6b7280;
  --primary: #005CA9;
  --bar-bg: #e5e7eb;
}

body.dark {
  color-scheme: dark;
  --bg: #020617;
  --card-bg: #020617;
  --border: #1e293b;
  --text-main: #e5e7eb;
  --text-muted: #9ca3af;
  --primary: #1d4ed8;
  --bar-bg: #0f172a;
}

body {
  margin:0;
  font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background: var(--bg);
  color: var(--text-main);
}
.wrap { max-width:780px; margin:0 auto; padding:14px; }
.card { background:var(--card-bg); border:1px solid var(--border); border-radius:10px; overflow:hidden; box-shadow:0 1px 3px rgba(15,23,42,.08); }

/* Header */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px 6px;
  border-bottom:1px solid var(--border);
}
.header-left {
  display:flex;
  align-items:center;
  gap:10px;
}
.header-left img { width:48px; height:auto; }
.header-left h1 {
  margin:0;
  font-size:20px;
  font-weight:800;
}
.ts { font-size:12px; color:var(--text-muted); margin-top:4px; }

/* Controls */
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  padding:10px 16px;
  border-bottom:1px solid var(--border);
}
.control-group { display:flex; align-items:center; gap:6px; font-size:13px; }
select, input[type="search"] {
  padding:6px 10px;
  font-size:14px;
  border-radius:6px;
  border:1px solid var(--border);
  background: var(--card-bg);
  color: var(--text-main);
}
.dark-toggle, .embed-btn, .refresh-btn {
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background: var(--card-bg);
  cursor:pointer;
  font-size:12px;
}

/* Banner pa√≠s */
.section-title {
  font-size:13px;
  font-weight:700;
  background:var(--primary);
  color:#fff;
  padding:8px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.section-title span:last-child { font-size:11px; opacity:.9; }

/* Candidate rows */
.candidate-row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 16px;
  border-bottom:1px solid var(--border);
  gap:6px;
}
.candidate-info { display:flex; align-items:center; gap:8px; }
.candidate-photo { width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid var(--border); }
.party-badge { padding:2px 6px; border-radius:4px; font-size:11px; font-weight:700; color:#fff; display:inline-block; }
.bar-rail { width:120px; background:var(--bar-bg); height:6px; border-radius:6px; overflow:hidden; }
.bar-fill { height:6px; border-radius:6px; }
.percent { font-weight:700; font-size:12px; margin-left:6px; }
.winner-tag { background:#FFD400; font-size:11px; padding:2px 4px; border-radius:4px; font-weight:700; margin-left:6px; }
.candidate-row.winner { background:rgba(59,130,246,0.05); }

/* Totals & footer */
.total-box {
  padding:10px 16px;
  border-top:1px solid var(--border);
  background:rgba(148,163,184,0.08);
  font-size:13px;
}
.total-box b { font-weight:700; }
.footer {
  padding:8px 16px 10px;
  font-size:11px;
  color:var(--text-muted);
  display:flex;
  justify-content:space-between;
  gap:8px;
  flex-wrap:wrap;
}

/* Modal embed */
.modal-backdrop {
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.modal {
  background:var(--card-bg);
  border-radius:10px;
  border:1px solid var(--border);
  max-width:520px;
  width:90%;
  padding:14px 16px;
  box-shadow:0 10px 30px rgba(15,23,42,.4);
}
.modal h3 { margin:0 0 8px; font-size:15px; font-weight:700; }
.modal p { margin:0 0 8px; font-size:12px; color:var(--text-muted); }
.modal textarea {
  width:100%;
  min-height:80px;
  padding:8px;
  font-size:12px;
  border-radius:6px;
  border:1px solid var(--border);
  resize:vertical;
  background:var(--card-bg);
  color:var(--text-main);
}
.modal-actions {
  margin-top:10px;
  display:flex;
  justify-content:flex-end;
  gap:8px;
}
.btn-sm { padding:6px 10px; font-size:12px; border-radius:999px; border:1px solid var(--border); background:var(--card-bg); cursor:pointer; }
.btn-primary-sm { border-color:var(--primary); color:#fff; background:var(--primary); }

@media (max-width:600px){
  .candidate-row { flex-direction:column; align-items:flex-start; }
  .bar-rail { width:100px; }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <img src="https://www.epicentrochile.com/wp-content/uploads/2017/05/logo-little.png" alt="Epicentro Logo">
        <h1>Presidencial 2025 ‚Äî Voto en el Extranjero</h1>
      </div>
      <div class="ts" id="ts">Actualizado‚Ä¶</div>
    </div>

    <!-- Controles (ocultos en modo embed) -->
    <div class="controls" id="controlsRow">
      <div class="control-group">
        <label for="countrySelect">Pa√≠s:</label>
        <select id="countrySelect"></select>
      </div>
      <div class="control-group">
        <span>Buscar:</span>
        <input type="search" id="countrySearch" placeholder="Escribe un pa√≠s‚Ä¶" />
      </div>
      <button id="refreshBtn" class="refresh-btn">üîÑ Actualizar ahora</button>
      <button id="embedBtn" class="embed-btn">üîó Generar embed</button>
    </div>

    <!-- Pa√≠s seleccionado -->
    <div id="countryTitle" class="section-title">
      <span>‚Äî</span><span>‚Äî</span>
    </div>

    <!-- Resultados -->
    <div id="results"></div>

    <!-- Totales -->
    <div class="total-box" id="totalBox">
      Total votos pa√≠s: ‚Äî ¬∑ Total exterior global: ‚Äî
    </div>

    <!-- Footer -->
    <div class="footer">
      <span>Actualiza cada 60s ¬∑ Fuente: Google Sheets (voto en el exterior)</span>
      <span id="ts2"></span>
    </div>
  </div>
</div>

<!-- Modal embed -->
<div class="modal-backdrop" id="embedModal">
  <div class="modal">
    <h3>C√≥digo embed para este pa√≠s</h3>
    <p>Copia y pega este iframe en tu nota o sitio para mostrar solo este pa√≠s.</p>
    <textarea id="embedCode" readonly></textarea>
    <div class="modal-actions">
      <button class="btn-sm" id="closeEmbed">Cerrar</button>
      <button class="btn-primary-sm" id="copyEmbed">üìã Copiar</button>
    </div>
  </div>
</div>

<script>
// ======================== BANDERAS SVG ========================
function flagSVG(country) {
  const ISO2 = {
    "Nueva Zelanda": "nz","Australia": "au","China": "cn","Corea": "kr",
    "Vietnam": "vn","Tailandia": "th","Singapur": "sg","Japon": "jp",
    "Indonesia": "id","Filipias": "ph","India": "in","Emiratos Arabes": "ae",
    "Jordania": "jo","Israel": "il","El Libano": "lb",
    "Alemania": "de","Austria":"at","Belgica":"be","Croacia":"hr",
    "Dinamarca":"dk","Espa√±a":"es","Federacion Rusa":"ru","Finlandia":"fi",
    "Francia":"fr","Grecia":"gr","Hungria":"hu","Irlanda":"ie","Italia":"it",
    "Noruega":"no","Paises Bajos":"nl","Polonia":"pl","Portugal":"pt",
    "Reino Unido":"gb","Republica Checa":"cz","Rumania":"ro","Suecia":"se",
    "Suiza":"ch","Turquia":"tr",
    "Argelia":"dz","Egipto":"eg","Kenia":"ke","Marruecos":"ma","Sudafrica":"za",
    "Argentina":"ar","Bolivia":"bo","Brasil":"br","Canada":"ca","Colombia":"co",
    "Cuba":"cu","Ecuador":"ec","El Salvador":"sv","Estados Unidos":"us",
    "Guatemala":"gt","Haiti":"ht","Honduras":"hn","Jamaica":"jm","Mexico":"mx",
    "Nicaragua":"ni","Panama":"pa","Paraguay":"py","Peru":"pe",
    "Republica Dominicana":"do","Uruguay":"uy"
  };
  const code = ISO2[country];
  if (!code) return "";
  return `<img src="https://flagcdn.com/24x18/${code}.png" style="width:18px;height:auto;border-radius:2px;vertical-align:middle;">`;
}

// ======================== CONTINENTES ========================
const CONT = {
  "Nueva Zelanda":"Ocean√≠a","Australia":"Ocean√≠a",
  "China":"Asia","Corea":"Asia","Vietnam":"Asia","Tailandia":"Asia",
  "Singapur":"Asia","Japon":"Asia","Indonesia":"Asia","Filipias":"Asia",
  "India":"Asia","Emiratos Arabes":"Asia","Jordania":"Asia","Israel":"Asia",
  "El Libano":"Asia",
  "Alemania":"Europa","Austria":"Europa","Belgica":"Europa","Croacia":"Europa",
  "Dinamarca":"Europa","Espa√±a":"Europa","Federacion Rusa":"Europa",
  "Finlandia":"Europa","Francia":"Europa","Grecia":"Europa","Hungria":"Europa",
  "Irlanda":"Europa","Italia":"Europa","Noruega":"Europa","Paises Bajos":"Europa",
  "Polonia":"Europa","Portugal":"Europa","Reino Unido":"Europa",
  "Republica Checa":"Europa","Rumania":"Europa","Suecia":"Europa",
  "Suiza":"Europa","Turquia":"Europa",
  "Argelia":"√Åfrica","Egipto":"√Åfrica","Kenia":"√Åfrica","Marruecos":"√Åfrica",
  "Sudafrica":"√Åfrica",
  "Argentina":"Am√©rica","Bolivia":"Am√©rica","Brasil":"Am√©rica","Canada":"Am√©rica",
  "Colombia":"Am√©rica","Cuba":"Am√©rica","Ecuador":"Am√©rica","El Salvador":"Am√©rica",
  "Estados Unidos":"Am√©rica","Guatemala":"Am√©rica","Haiti":"Am√©rica",
  "Honduras":"Am√©rica","Jamaica":"Am√©rica","Mexico":"Am√©rica","Nicaragua":"Am√©rica",
  "Panama":"Am√©rica","Paraguay":"Am√©rica","Peru":"Am√©rica",
  "Republica Dominicana":"Am√©rica","Uruguay":"Am√©rica"
};

// PARTIDOS ‚Üí COLOR
const PARTY_COLORS = {
  "PDG": "#9333EA","PC": "#E5252A","IND": "#6b7280",
  "PNL": "#6b7280","REP": "#1D4ED8","UDI": "#059669"
};

// CONFIG
const SHEET_URL =
 "https://docs.google.com/spreadsheets/d/1e1hdX19TAZIiOnTfPgcCmfOh0HujEHWNEYn5WBiAFz8/export?format=csv&gid=327892612";
const REFRESH_MS = 60000;
const BASE_EMBED_URL = "https://rustemah.github.io/epicentro-exterior/";

// Datos
let CAND_NAMES = [], CAND_PARTY = [], CAND_PHOTO = [];
let COUNTRIES = [];   // { name, continent, votes:[...], total }
let GLOBAL_TOTALS = []; // suma por candidato

function parseIntClean(x){
  return Number(String(x||"0").replace(/[^\d]/g,"")) || 0;
}

// Leer hoja
function parseSheet(text){
  const lines = text.trim().split(/\r?\n/);
  if(lines.length < 5) return;

  const row1 = lines[0].split(",").map(s=>s.trim());
  const row2 = lines[1].split(",").map(s=>s.trim());
  const row3 = lines[2].split(",").map(s=>s.trim());

  CAND_NAMES = row1.slice(1);
  CAND_PARTY = row2.slice(1);
  CAND_PHOTO = row3.slice(1);

  const numCands = CAND_NAMES.length;

  COUNTRIES = [];
  for(let i=4; i<lines.length; i++){
    const cols = lines[i].split(",").map(s=>s.trim());
    const name = cols[0];
    if(!name) continue;
    const cont = CONT[name] || "Otro";
    const rawVotes = cols.slice(1, 1+numCands);
    const votes = rawVotes.map(parseIntClean);
    const total = votes.reduce((a,b)=>a+b,0);
    COUNTRIES.push({name, continent:cont, votes, total});
  }

  GLOBAL_TOTALS = new Array(numCands).fill(0);
  COUNTRIES.forEach(c=>{
    c.votes.forEach((v,i)=>GLOBAL_TOTALS[i]+=v);
  });
}

// Construir men√∫ (solo pa√≠ses con datos >0)
function buildCountryOptions(filter=""){
  const sel = document.getElementById("countrySelect");
  const q = filter.toLowerCase();
  sel.innerHTML = "";

  const continentsOrder = ["Am√©rica","Europa","Asia","√Åfrica","Ocean√≠a","Otro"];

  const optGlobal = document.createElement("option");
  optGlobal.value = "GLOBAL";
  optGlobal.textContent = "üåé Total voto exterior";
  sel.appendChild(optGlobal);

  continentsOrder.forEach(cont=>{
    const subset = COUNTRIES.filter(c => c.continent===cont && c.total>0 && (!q || c.name.toLowerCase().includes(q)));
    if(!subset.length) return;
    const og = document.createElement("optgroup");
    og.label = cont;
    subset.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.name;
      opt.innerHTML = `${flagSVG(c.name)}&nbsp;${c.name}`;
      og.appendChild(opt);
    });
    sel.appendChild(og);
  });
}

// Render pa√≠s
function renderCountry(value){
  const countryTitle = document.getElementById("countryTitle");
  const resultsDiv   = document.getElementById("results");
  const totalBox     = document.getElementById("totalBox");
  resultsDiv.innerHTML = "";

  let localVotes = [];
  let localTotal = 0;
  const globalTotal = GLOBAL_TOTALS.reduce((a,b)=>a+b,0);

  if(value === "GLOBAL"){
    localVotes = [...GLOBAL_TOTALS];
    localTotal = globalTotal;
    countryTitle.innerHTML = `<span>üåé TOTAL VOTO EXTERIOR</span><span>${globalTotal.toLocaleString("es-CL")}</span>`;
  } else {
    const obj = COUNTRIES.find(c => c.name === value);
    if(!obj){
      countryTitle.innerHTML = `<span>Sin datos para ${value}</span><span>‚Äî</span>`;
      totalBox.innerHTML = `Total votos en el pa√≠s seleccionado: <b>0</b> ¬∑ Total exterior global: <b>${globalTotal.toLocaleString("es-CL")}</b>`;
      return;
    }
    localVotes = obj.votes;
    localTotal = obj.total;
    const flag = flagSVG(obj.name);
    countryTitle.innerHTML = `<span>${flag}&nbsp;${obj.name.toUpperCase()}</span><span>${obj.continent.toUpperCase()}</span>`;
  }

  const list = CAND_NAMES.map((name,i)=>({
    name,
    party: CAND_PARTY[i],
    photo: CAND_PHOTO[i],
    votes: localVotes[i] || 0
  }));

  list.sort((a,b)=>b.votes-a.votes);
  const maxVotes = list.length ? list[0].votes : 0;

  list.forEach(c=>{
    const color = PARTY_COLORS[c.party] || "#6b7280";
    const pct   = localTotal>0 ? (c.votes/localTotal*100) : 0;
    const isW   = c.votes === maxVotes && c.votes>0;

    const row = document.createElement("div");
    row.className = "candidate-row" + (isW?" winner":"");
    row.innerHTML = `
      <div class="candidate-info">
        <img src="${c.photo}" class="candidate-photo" alt="${c.name}">
        <div>
          <div style="font-weight:700;">${c.name}${isW?`<span class="winner-tag">‚úì Gana aqu√≠</span>`:""}</div>
          <span class="party-badge" style="background:${color};">${c.party}</span>
        </div>
      </div>
      <div style="text-align:right;">
        <div>${c.votes.toLocaleString("es-CL")}</div>
        <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;margin-top:4px;">
          <div class="bar-rail"><div class="bar-fill" style="width:${pct.toFixed(1)}%;background:${color};"></div></div>
          <span class="percent">${pct.toFixed(1)}%</span>
        </div>
      </div>
    `;
    resultsDiv.appendChild(row);
  });

  if(value==="GLOBAL"){
    totalBox.innerHTML = `Total votos v√°lidos (exterior): <b>${globalTotal.toLocaleString("es-CL")}</b>`;
  } else {
    totalBox.innerHTML =
      `Total votos en el pa√≠s seleccionado: <b>${localTotal.toLocaleString("es-CL")}</b> ¬∑ Total exterior global: <b>${globalTotal.toLocaleString("es-CL")}</b>`;
  }
}

// Carga principal
async function load(){
  try{
    const res = await fetch(SHEET_URL + "&t=" + Date.now(), {cache:"no-store"});
    const text = await res.text();
    parseSheet(text);

    const params = new URLSearchParams(window.location.search);
    const embedPais = params.get("pais");

    buildCountryOptions("");

    if(embedPais){
      // modo embed: solo pa√≠s
      document.getElementById("controlsRow").style.display = "none";
      const header = document.querySelector(".header");
      // opcional: ocultar bot√≥n actualizar/ embed si agregamos dark mode, etc
      renderCountry(embedPais);
    } else {
      document.getElementById("countrySelect").value = "GLOBAL";
      renderCountry("GLOBAL");
    }

    const stamp = new Date().toLocaleString("es-CL",{dateStyle:"medium",timeStyle:"short"});
    document.getElementById("ts").textContent  = "Actualizado: " + stamp;
    document.getElementById("ts2").textContent = stamp;
  }catch(e){
    console.error(e);
  }
}

// Eventos UI
document.getElementById("countrySelect").addEventListener("change", e=>{
  renderCountry(e.target.value);
});

document.getElementById("countrySearch").addEventListener("input", e=>{
  const q = e.target.value;
  const current = document.getElementById("countrySelect").value;
  buildCountryOptions(q);
  const sel = document.getElementById("countrySelect");
  const opt = Array.from(sel.options).find(o=>o.value===current);
  sel.value = opt ? current : "GLOBAL";
  renderCountry(sel.value);
});

document.getElementById("refreshBtn").addEventListener("click", ()=>{
  const btn = document.getElementById("refreshBtn");
  btn.textContent = "‚è≥ Actualizando‚Ä¶";
  load().then(()=> btn.textContent = "üîÑ Actualizar ahora");
});

// Modal embed
const embedBtn   = document.getElementById("embedBtn");
const embedModal = document.getElementById("embedModal");
const closeEmbed = document.getElementById("closeEmbed");
const copyEmbed  = document.getElementById("copyEmbed");
const embedCode  = document.getElementById("embedCode");

embedBtn.addEventListener("click", ()=>{
  const sel = document.getElementById("countrySelect");
  const val = sel.value;
  if(val === "GLOBAL"){
    alert("Selecciona primero un pa√≠s para generar su embed.");
    return;
  }
  const url = "https://rustemah.github.io/epicentro-exterior/?pais=" + encodeURIComponent(val);
  const code = `<iframe src="${url}" width="100%" height="420" frameborder="0" loading="lazy"></iframe>`;
  embedCode.value = code;
  embedModal.style.display = "flex";
});

closeEmbed.addEventListener("click", ()=>{
  embedModal.style.display = "none";
});

copyEmbed.addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(embedCode.value);
    copyEmbed.textContent = "‚úÖ Copiado";
    setTimeout(()=>copyEmbed.textContent="üìã Copiar",1500);
  }catch(e){
    copyEmbed.textContent="Error";
  }
});

embedModal.addEventListener("click", (e)=>{
  if(e.target === embedModal) embedModal.style.display = "none";
});

// Arranque + auto refresh
load();
setInterval(load, REFRESH_MS);
</script>
</body>
</html>
